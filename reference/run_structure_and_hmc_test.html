<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Run structural diagnostics and (optional) HMC/NUTS smoke test — run_structure_and_hmc_test • samOptiPro</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Run structural diagnostics and (optional) HMC/NUTS smoke test — run_structure_and_hmc_test"><meta name="description" content="Inspects a NIMBLE model produced by build_fn() to:
count stochastic vs. deterministic nodes (optionally including data),
parse the model code to detect non-differentiable functions and BUGS-style truncation,
rebuild a per-node table with distribution, support, and bounds,
tag HMC showstoppers (e.g., discrete latents, simplex constraints, truncation,
non-differentiable deterministic ops feeding latents),
optionally attempt a short HMC/NUTS run (via nimbleHMC) to check practical feasibility.

"><meta property="og:description" content="Inspects a NIMBLE model produced by build_fn() to:
count stochastic vs. deterministic nodes (optionally including data),
parse the model code to detect non-differentiable functions and BUGS-style truncation,
rebuild a per-node table with distribution, support, and bounds,
tag HMC showstoppers (e.g., discrete latents, simplex constraints, truncation,
non-differentiable deterministic ops feeding latents),
optionally attempt a short HMC/NUTS run (via nimbleHMC) to check practical feasibility.

"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">samOptiPro</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RomualdEcoStats/samOptiPro-core" aria-label="Source on GitHub"><span class="fa fab fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Run structural diagnostics and (optional) HMC/NUTS smoke test</h1>
      <small class="dont-index">Source: <a href="https://github.com/RomualdEcoStats/samOptiPro-core/blob/main/R/diagnostics.R" class="external-link"><code>R/diagnostics.R</code></a></small>
      <div class="d-none name"><code>run_structure_and_hmc_test.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Inspects a NIMBLE model produced by <code>build_fn()</code> to:</p><ul><li><p>count stochastic vs. deterministic nodes (optionally including data),</p></li>
<li><p>parse the model code to detect non-differentiable functions and BUGS-style truncation,</p></li>
<li><p>rebuild a per-node table with distribution, support, and bounds,</p></li>
<li><p>tag <strong>HMC showstoppers</strong> (e.g., discrete latents, simplex constraints, truncation,
non-differentiable deterministic ops feeding latents),</p></li>
<li><p>optionally attempt a short HMC/NUTS run (via <span class="pkg">nimbleHMC</span>) to check practical feasibility.</p></li>
</ul></div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">run_structure_and_hmc_test</span><span class="op">(</span></span>
<span>  <span class="va">build_fn</span>,</span>
<span>  include_data <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  try_hmc <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  niter <span class="op">=</span> <span class="fl">50L</span>,</span>
<span>  nburnin <span class="op">=</span> <span class="fl">10L</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1L</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-build-fn">build_fn<a class="anchor" aria-label="anchor" href="#arg-build-fn"></a></dt>
<dd><p>A zero-arg function returning a list with at least
<code>model</code> (<code>nimbleModel</code>); optional elements: <code>cmodel</code>, <code>monitors</code>,
<code>code_text</code> (or <code>code</code>) used to strengthen non-diff detection.</p></dd>


<dt id="arg-include-data">include_data<a class="anchor" aria-label="anchor" href="#arg-include-data"></a></dt>
<dd><p>Logical; include data nodes in counts and scans. Default <code>FALSE</code>.</p></dd>


<dt id="arg-try-hmc">try_hmc<a class="anchor" aria-label="anchor" href="#arg-try-hmc"></a></dt>
<dd><p>Logical; if <code>TRUE</code>, attempt a brief HMC/NUTS run. Default <code>TRUE</code>.</p></dd>


<dt id="arg-niter">niter<a class="anchor" aria-label="anchor" href="#arg-niter"></a></dt>
<dd><p>Integer; total iterations for the HMC test. Default <code>50L</code>.</p></dd>


<dt id="arg-nburnin">nburnin<a class="anchor" aria-label="anchor" href="#arg-nburnin"></a></dt>
<dd><p>Integer; burn-in for the HMC test. Default <code>10L</code>.</p></dd>


<dt id="arg-seed">seed<a class="anchor" aria-label="anchor" href="#arg-seed"></a></dt>
<dd><p>Integer; RNG seed for the HMC run. Default <code>1L</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An invisible list with components:</p><ul><li><p><code>diag</code>: list with <code>nodes</code> (data.frame of node metadata and HMC showstopper tags),
<code>nondiff_signals</code>, <code>code_scan</code>, <code>hmc_globally_ok</code>.</p></li>
<li><p><code>hmc</code>: list describing the HMC trial (<code>ok</code>, <code>error</code>, <code>details</code>).</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Compared to <code><a href="diagnose_model_structure.html">diagnose_model_structure()</a></code>, this function does not filter nodes by
ignore patterns or explicit removals and does not compute dependency fan-out.
Its emphasis is <em>HMC suitability</em> rather than structural load.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">run_structure_and_hmc_test</span><span class="op">(</span><span class="va">my_builder</span>, include_data <span class="op">=</span> <span class="cn">FALSE</span>, try_hmc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">out</span><span class="op">$</span><span class="va">hmc</span><span class="op">$</span><span class="va">ok</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"HMC not feasible: "</span>, <span class="va">out</span><span class="op">$</span><span class="va">hmc</span><span class="op">$</span><span class="va">error</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span><span class="va">run_structure_and_hmc_test</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> function (build_fn, include_data = FALSE, try_hmc = TRUE, niter = 50L, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     nburnin = 10L, seed = 1L) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     `%||%` &lt;- function(a, b) if (is.null(a)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         b</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     else a</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     to_logical &lt;- function(x) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (is.logical(x)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             return(x)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (is.numeric(x)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             return(x != 0)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (is.factor(x)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             x &lt;- as.character(x)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (is.character(x)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             y &lt;- tolower(trimws(x))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             return(y %in% c("true", "t", "1", "yes", "y"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         rep(FALSE, length(x))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     strip_index &lt;- function(x) sub("\\[.*\\]$", "", x)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     normalize_dist &lt;- function(d) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- tolower(trimws(d %||% ""))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (d == "") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             return(NA_character_)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- sub("^dbernoulli$", "dbern", d)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- sub("^dbin$", "dbinom", d)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- sub("^dmulti$", "dmultinom", d)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- sub("^dnbinom$", "dnegbin", d)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- sub("^ddirich(let)?$", "ddirichlet", d)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- sub("^ddirch(let)?$", "ddirichlet", d)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- sub("^dhyperg(eometric)?$", "dhypergeom", d)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- sub("^dhyper$", "dhypergeom", d)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- sub("^dpois_rate$", "dpois", d)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- sub("^dtri(angle)?$", "dtriangle", d)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- sub("^dhalfnorm(al)?$", "dhalfnorm", d)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- sub("^dhalfcauchy$", "dhalfcauchy", d)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     discrete_dists &lt;- c("dbern", "dbinom", "dcat", "dmultinom", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         "dgeom", "dnegbin", "dpois", "dhypergeom", "dinterval")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     simplex_dists &lt;- c("ddirichlet")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     bounded_support_dists &lt;- c("dbeta", "dunif", "dtriangle", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         "dhalfnorm", "dhalfcauchy")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     support_of &lt;- function(dist_name, lb, ub) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         d &lt;- normalize_dist(dist_name)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (is.na(d)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             return("unknown")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (d %in% discrete_dists) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             return("discrete")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (d %in% simplex_dists) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             return("simplex")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (d %in% bounded_support_dists) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             return("bounded-continuous")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         "continuous"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     .sop_supports_derivs &lt;- function(model) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         bd1 &lt;- try(model$modelDef$buildDerivs, silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!inherits(bd1, "try-error") &amp;&amp; !is.null(bd1)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             return(isTRUE(bd1))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         bd2 &lt;- try(model$buildDerivs, silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!inherits(bd2, "try-error") &amp;&amp; !is.null(bd2)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             return(isTRUE(bd2))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (requireNamespace("nimbleHMC", quietly = TRUE)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             conf &lt;- try(nimble::configureMCMC(model), silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (!inherits(conf, "try-error")) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 ok &lt;- TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 tryCatch({</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   nimbleHMC::configureHMC(conf, model = model)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 }, error = function(e) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   msg &lt;- tolower(conditionMessage(e))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   if (grepl("deriv", msg) || grepl("buildderiv", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     msg)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     ok &lt;&lt;- FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 })</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 return(ok)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     stopifnot(is.function(build_fn))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     parts &lt;- build_fn()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     m &lt;- parts$model</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cm &lt;- parts$cmodel %||% NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     mons &lt;- parts$monitors %||% character(0)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     code_override &lt;- parts$code_text %||% parts$code %||% NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (!is.null(code_override) &amp;&amp; !is.character(code_override)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         code_override &lt;- try(paste(deparse(code_override), collapse = "\n"), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (inherits(code_override, "try-error")) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             code_override &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cat("\n[STRUCTURE]\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cat(sprintf("- # stochastic nodes   : %d\n", length(m$getNodeNames(stochOnly = TRUE, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         includeData = include_data))))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cat(sprintf("- # deterministic nodes: %d\n", length(m$getNodeNames(stochOnly = FALSE, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         includeData = include_data)) - length(m$getNodeNames(stochOnly = TRUE, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         includeData = include_data))))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     .sop_detect_nondiff_functions &lt;- function(model, nondiff_candidates = c("round", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         "floor", "ceiling", "trunc", "abs", "max", "min", "step", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         "ifElse", "ifelse", "equals"), code_text_override = NULL) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         out &lt;- character(0)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         code_txt &lt;- ""</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (is.character(code_text_override) &amp;&amp; length(code_text_override)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             code_txt &lt;- paste(code_text_override, collapse = "\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             code_try &lt;- try({</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 code_txt &lt;- paste0(paste(deparse(model$modelDef$code, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   width.cutoff = 500), collapse = "\n"), "\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }, silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (inherits(code_try, "try-error") || is.null(code_txt) || </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 nchar(code_txt) == 0) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 code_txt &lt;- tryCatch(paste(utils::capture.output(print(model)), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   collapse = "\n"), error = function(e) "")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (nchar(code_txt)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             for (fn in nondiff_candidates) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 pat1 &lt;- paste0("\\b", fn, "\\s*\\(")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 pat2 &lt;- paste0("(?i)\\b", fn, "\\s*\\(")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 if (grepl(pat1, code_txt, perl = TRUE) || grepl(pat2, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   code_txt, perl = TRUE)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   out &lt;- c(out, fn)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         pull_char &lt;- function(x) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             x &lt;- try(x, silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (inherits(x, "try-error") || is.null(x)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 return(character(0))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             as.character(unlist(x, use.names = FALSE))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         maps &lt;- try(model$modelDef$maps, silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!inherits(maps, "try-error") &amp;&amp; !is.null(maps)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             out &lt;- c(out, pull_char(maps$nodeFxnNames))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             out &lt;- c(out, pull_char(maps$allFxnNames))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             out &lt;- c(out, pull_char(maps$fxnNamesByNode))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             out &lt;- c(out, pull_char(maps$deterministicFxnNames))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         out &lt;- unique(tolower(out))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         hits &lt;- intersect(out, tolower(nondiff_candidates))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         list(hits = hits, code_txt = code_txt)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     nd &lt;- .sop_detect_nondiff_functions(m, code_text_override = code_override)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     nondiff_hits &lt;- nd$hits</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     code_txt_scanned &lt;- nd$code_txt</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     truncation_detected_bugst &lt;- grepl("\\)\\s*T\\s*\\(", code_txt_scanned, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         perl = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     dists_in_code_raw &lt;- unique(tolower(unlist(regmatches(code_txt_scanned, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         gregexpr("\\bd[a-zA-Z_]+\\b", code_txt_scanned, perl = TRUE)))))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     dists_in_code &lt;- unique(vapply(dists_in_code_raw, normalize_dist, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         character(1)))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     diag_raw &lt;- try(diagnose_model_structure(m, include_data = include_data), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     rebuild_nodes_df &lt;- function(model, include_data) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         all_nodes &lt;- model$getNodeNames(includeData = include_data)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         stoch &lt;- model$getNodeNames(stochOnly = TRUE, includeData = include_data)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         is_data_vec &lt;- stats::setNames(rep(FALSE, length(all_nodes)), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             all_nodes)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         for (n in all_nodes) is_data_vec[n] &lt;- tryCatch(model$isData(n), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             error = function(e) FALSE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         get_dist_raw &lt;- function(node) tolower(tryCatch(model$getDistribution(node), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             error = function(e) NA_character_))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         get_bound &lt;- function(node, side) suppressWarnings(tryCatch(model$getBound(node, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             side), error = function(e) NA_real_))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nodes_df &lt;- do.call(rbind, lapply(all_nodes, function(node) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             is_stoch &lt;- node %in% stoch</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             dist_raw &lt;- if (is_stoch) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 get_dist_raw(node)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else NA_character_</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             dist &lt;- if (is_stoch) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 normalize_dist(dist_raw)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else NA_character_</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             lb &lt;- if (is_stoch) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 get_bound(node, "lower")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else NA_real_</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             ub &lt;- if (is_stoch) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 get_bound(node, "upper")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else NA_real_</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             sup &lt;- if (is_stoch) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 support_of(dist, lb, ub)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else NA_character_</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             data.frame(node = node, var = strip_index(node), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 is_stoch = is_stoch, is_data = is_data_vec[[node]], </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 dist_raw = dist_raw, dist = dist, support = sup, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 lower = lb, upper = ub, stringsAsFactors = FALSE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nodes_df$var &lt;- as.character(nodes_df$var)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nodes_df$is_stoch &lt;- to_logical(nodes_df$is_stoch)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nodes_df$is_data &lt;- to_logical(nodes_df$is_data)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         fin_lb &lt;- is.finite(as.numeric(nodes_df$lower))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         fin_ub &lt;- is.finite(as.numeric(nodes_df$upper))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         trunc_by_bounds &lt;- nodes_df$is_stoch &amp; (nodes_df$support == </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             "continuous") &amp; fin_lb &amp; fin_ub</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nodes_df$is_truncated &lt;- trunc_by_bounds | (nodes_df$is_stoch &amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             isTRUE(truncation_detected_bugst))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nodes_df$hmc_showstopper_reason &lt;- NA_character_</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nodes_df$hmc_showstopper_reason[nodes_df$is_stoch &amp; !nodes_df$is_data &amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nodes_df$support == "discrete"] &lt;- "discrete-latent"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nodes_df$hmc_showstopper_reason[nodes_df$is_stoch &amp; !nodes_df$is_data &amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nodes_df$support == "simplex" &amp; is.na(nodes_df$hmc_showstopper_reason)] &lt;- "simplex-constraint"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nodes_df$hmc_showstopper_reason[nodes_df$is_stoch &amp; !nodes_df$is_data &amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nodes_df$is_truncated &amp; is.na(nodes_df$hmc_showstopper_reason)] &lt;- "truncation"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (length(nondiff_hits)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nodes_df$hmc_showstopper_reason[!nodes_df$is_stoch &amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 is.na(nodes_df$hmc_showstopper_reason)] &lt;- "non-diff-deterministic-op"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         vars &lt;- unique(nodes_df$var)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         dims &lt;- lapply(vars, function(v) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             vi &lt;- tryCatch(model$getVarInfo(v), error = function(e) NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (is.null(vi) || is.null(vi$nDim)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 NA_integer_</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else as.integer(vi$nDim)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         })</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         names(dims) &lt;- vars</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nodes_df$dims &lt;- unname(vapply(nodes_df$var, function(v) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (v %in% names(dims)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 dims[[v]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else NA_integer_</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }, integer(1)))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nodes_df</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     nodes &lt;- if (!inherits(diag_raw, "try-error") &amp;&amp; is.list(diag_raw) &amp;&amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         is.data.frame(diag_raw$nodes)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nds &lt;- diag_raw$nodes</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if ("dist" %in% names(nds)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nds$dist &lt;- vapply(nds$dist, normalize_dist, character(1))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if ("dist_raw" %in% names(nds)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nds$dist_raw &lt;- tolower(nds$dist_raw)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nds$var &lt;- as.character(nds$var)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nds$is_stoch &lt;- to_logical(nds$is_stoch)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nds$is_data &lt;- to_logical(nds$is_data %||% FALSE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         fin_lb &lt;- is.finite(as.numeric(nds$lower %||% NA_real_))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         fin_ub &lt;- is.finite(as.numeric(nds$upper %||% NA_real_))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         trunc_by_bounds &lt;- nds$is_stoch &amp; (mapply(support_of, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nds$dist, nds$lower, nds$upper, SIMPLIFY = TRUE) == </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             "continuous") &amp; fin_lb &amp; fin_ub</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nds$is_truncated &lt;- trunc_by_bounds | (nds$is_stoch &amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             isTRUE(truncation_detected_bugst))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nds$support &lt;- mapply(support_of, nds$dist, nds$lower, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nds$upper, SIMPLIFY = TRUE, USE.NAMES = FALSE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!"hmc_showstopper_reason" %in% names(nds)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nds$hmc_showstopper_reason &lt;- NA_character_</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nds$hmc_showstopper_reason[nds$is_stoch &amp; !nds$is_data &amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nds$support == "discrete"] &lt;- "discrete-latent"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nds$hmc_showstopper_reason[nds$is_stoch &amp; !nds$is_data &amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nds$support == "simplex" &amp; is.na(nds$hmc_showstopper_reason)] &lt;- "simplex-constraint"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nds$hmc_showstopper_reason[nds$is_stoch &amp; !nds$is_data &amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nds$is_truncated &amp; is.na(nds$hmc_showstopper_reason)] &lt;- "truncation"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (length(nondiff_hits)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nds$hmc_showstopper_reason[!nds$is_stoch &amp; is.na(nds$hmc_showstopper_reason)] &lt;- "non-diff-deterministic-op"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!"dims" %in% names(nds)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             vars &lt;- unique(nds$var)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             dims &lt;- lapply(vars, function(v) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 vi &lt;- tryCatch(m$getVarInfo(v), error = function(e) NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 if (is.null(vi) || is.null(vi$nDim)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   NA_integer_</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 else as.integer(vi$nDim)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             })</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             names(dims) &lt;- vars</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nds$dims &lt;- unname(vapply(nds$var, function(v) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 if (v %in% names(dims)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   dims[[v]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 else NA_integer_</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }, integer(1)))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nds</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         rebuild_nodes_df(m, include_data)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cat("\n[NON-DIFF INDICATORS]\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cat(sprintf("- Non-diff functions detected: %s\n", if (length(nondiff_hits)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         paste(nondiff_hits, collapse = ",")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     else "None"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cat(sprintf("- Distributions found in code : %s\n", if (length(dists_in_code)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         paste(sort(unique(dists_in_code)), collapse = ", ")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     else "None"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     bounded_latent_trunc &lt;- any(nodes$is_stoch &amp; !nodes$is_data &amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         (nodes$support == "continuous") &amp; is.finite(nodes$lower) &amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         is.finite(nodes$upper), na.rm = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cat(sprintf("- BUGS-style truncation 'T(a,b)' spotted: %s\n", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (isTRUE(truncation_detected_bugst)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             "Yes"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else "No"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cat(sprintf("- Bounded latent nodes (implicit truncation via finite bounds on continuous support): %s\n", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (bounded_latent_trunc) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             "Yes"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else "No"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (length(nondiff_hits)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         code_lines &lt;- unlist(strsplit(code_txt_scanned, "\n", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             fixed = TRUE))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         round_lines &lt;- grep("\\bround\\s*\\(", code_lines, value = TRUE, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             perl = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         vars_in_lines &lt;- unique(gsub("\\[.*?\\]$", "", unlist(regmatches(round_lines, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             gregexpr("\\b[A-Za-z_][A-Za-z0-9_]*(\\[[^\\]]+\\])?", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 round_lines, perl = TRUE)))))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         vars_in_model &lt;- unique(nodes$var)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         seed_vars &lt;- intersect(vars_in_lines, vars_in_model)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         latents &lt;- nodes$node[nodes$is_stoch &amp; !nodes$is_data]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         det_anc_all &lt;- unique(unlist(lapply(latents, function(nd) tryCatch(m$getDependencies(target = nd, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             upstream = TRUE, downstream = FALSE, includeData = FALSE, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             stochOnly = FALSE), error = function(e) character(0)))))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         det_anc_vars &lt;- gsub("\\[.*?\\]$", "", det_anc_all)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         to_tag &lt;- det_anc_all[det_anc_vars %in% seed_vars]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         is_det &lt;- !nodes$is_stoch</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nodes$hmc_showstopper_reason[is_det] &lt;- ifelse(nodes$node[is_det] %in% </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             to_tag, "non-diff-deterministic-op", NA_character_)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cat("\n[DEBUG before summarise_showstoppers]\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cat("has hmc_showstopper_reason? ", "hmc_showstopper_reason" %in% </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         names(nodes), "\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if ("hmc_showstopper_reason" %in% names(nodes)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         cat("non-NA reasons (non-data): ", sum(!nodes$is_data &amp; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             !is.na(nodes$hmc_showstopper_reason)), "\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         print(utils::head(nodes[!nodes$is_data &amp; !is.na(nodes$hmc_showstopper_reason), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             c("node", "is_stoch", "hmc_showstopper_reason")], </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             10), row.names = FALSE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     summarise_showstoppers &lt;- function(nodes_df) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         ss &lt;- nodes_df</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!"hmc_showstopper_reason" %in% names(ss)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             ss$hmc_showstopper_reason &lt;- NA_character_</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!"is_data" %in% names(ss)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             ss$is_data &lt;- FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         ss$is_data &lt;- to_logical(ss$is_data)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         ss &lt;- ss[!is.na(ss$hmc_showstopper_reason) &amp; !ss$is_data, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             , drop = FALSE]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!nrow(ss)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             return(list(summary = data.frame(reason = character(0), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 n_nodes = integer(0)), examples = data.frame(reason = character(0), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 examples = character(0))))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         tt &lt;- as.data.frame(table(ss$hmc_showstopper_reason), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             stringsAsFactors = FALSE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         names(tt) &lt;- c("reason", "n_nodes")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         tt$n_nodes &lt;- as.integer(tt$n_nodes)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         tt &lt;- tt[order(-tt$n_nodes, tt$reason), , drop = FALSE]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         ex &lt;- do.call(rbind, lapply(split(ss, ss$hmc_showstopper_reason), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             function(d) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 data.frame(reason = as.character(d$hmc_showstopper_reason[1]), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   examples = paste(unique(utils::head(as.character(d$node), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     5)), collapse = ","), stringsAsFactors = FALSE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         rownames(ex) &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         list(summary = tt, examples = ex)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ss &lt;- summarise_showstoppers(nodes)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cat("\n[HMC/NUTS SHOWSTOPPERS]\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (nrow(ss$summary)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         print(ss$summary, row.names = FALSE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         cat("\nExamples by reason:\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         print(ss$examples, row.names = FALSE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         reasons &lt;- unique(stats::na.omit(nodes$hmc_showstopper_reason[!nodes$is_data]))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (length(reasons)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             cat("(no table -- fallback summary)\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             cat("Reasons: ", paste(sort(reasons), collapse = ", "), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 "\n", sep = "")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             cat("- No explicit showstoppers detected at latent nodes.\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     hsk &lt;- nodes$hmc_showstopper_reason %||% rep(NA_character_, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nrow(nodes))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     hmc_globally_ok &lt;- all(is.na(hsk[!nodes$is_data]))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cat(sprintf("\n- HMC globally feasible? %s\n", if (isTRUE(hmc_globally_ok)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         "Yes"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     else "No"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     hmc_res &lt;- list(ok = FALSE, error = "HMC test not requested.", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         details = NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (isTRUE(try_hmc)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         cat("\n[HMC/NUTS SMOKE TEST]\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         has_hmc &lt;- suppressWarnings(requireNamespace("nimbleHMC", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             quietly = TRUE))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!has_hmc) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             msg &lt;- "nimbleHMC not available (not installed or not loaded)."</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             cat(sprintf("- HMC feasible? No\n  reason: %s\n", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 msg))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             hmc_res &lt;- list(ok = FALSE, error = msg, details = NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else if (!isTRUE(hmc_globally_ok)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             reasons &lt;- unique(stats::na.omit(nodes$hmc_showstopper_reason[!nodes$is_data]))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             msg &lt;- sprintf("Model not suitable for HMC/NUTS (structural): %s", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 paste(reasons, collapse = ","))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             cat(sprintf("- HMC feasible? No\n  reason: %s\n", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 msg))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             hmc_res &lt;- list(ok = FALSE, error = msg, details = NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             model_has_derivs &lt;- .sop_supports_derivs(m)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (!isTRUE(model_has_derivs)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 msg &lt;- "NUTS not attempted: the model was not built with buildDerivs=TRUE."</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 cat(sprintf("- HMC feasible? No\n  reason: %s\n", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   msg))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 hmc_res &lt;- list(ok = FALSE, error = msg, details = NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 base_conf &lt;- try(nimble::configureMCMC(m), silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 if (inherits(base_conf, "try-error")) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   msg &lt;- paste("configureMCMC failed:", as.character(base_conf))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   cat(sprintf("- HMC feasible? No\n  reason: %s\n", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     msg))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   hmc_res &lt;- list(ok = FALSE, error = msg, details = NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   if (length(mons)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     try(base_conf$addMonitors(mons), silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   okH &lt;- TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   tryCatch({</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     nimbleHMC::configureHMC(base_conf, model = m)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   }, error = function(e) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     okH &lt;&lt;- FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     cat("configureHMC failed: ", e$message, "\n", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       sep = "")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   })</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   if (!okH) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     msg &lt;- "configureHMC failed."</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     cat(sprintf("- HMC feasible? No\n  reason: %s\n", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       msg))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     hmc_res &lt;- list(ok = FALSE, error = msg, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       details = NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     mcmc &lt;- try(nimble::buildMCMC(base_conf), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     if (inherits(mcmc, "try-error")) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       msg &lt;- paste("buildMCMC failed:", as.character(mcmc))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       cat(sprintf("- HMC feasible? No\n  reason: %s\n", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         msg))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       hmc_res &lt;- list(ok = FALSE, error = msg, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         details = NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       cm_obj &lt;- if (!is.null(cm)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         cm</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       else try(nimble::compileNimble(m), silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       cmcmc &lt;- try(nimble::compileNimble(mcmc, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         project = cm_obj, resetFunctions = TRUE), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       if (inherits(cmcmc, "try-error")) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         msg &lt;- paste("compileNimble failed:", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           as.character(cmcmc))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         cat(sprintf("- HMC feasible? No\n  reason: %s\n", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           msg))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         hmc_res &lt;- list(ok = FALSE, error = msg, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           details = NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         set.seed(seed)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         run &lt;- try(nimble::runMCMC(cmcmc, niter = as.integer(niter), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           nburnin = as.integer(nburnin), thin = 1L, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           nchains = 1L, samplesAsCodaMCMC = FALSE, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           summary = FALSE, WAIC = FALSE), silent = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         if (inherits(run, "try-error")) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           msg &lt;- paste("runMCMC failed:", as.character(run))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           cat(sprintf("- HMC feasible? No\n  reason: %s\n", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                             msg))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           hmc_res &lt;- list(ok = FALSE, error = msg, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                             details = NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           cat("- HMC feasible? Yes\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           hmc_res &lt;- list(ok = TRUE, error = NULL, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                             details = run)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                       }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     invisible(list(diag = list(nodes = nodes, nondiff_signals = list(functions_found = sort(unique(nondiff_hits)), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         distributions_found = sort(unique(dists_in_code)), distributions_found_raw = sort(unique(dists_in_code_raw)), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         truncation_bugst = truncation_detected_bugst, bounded_latent_trunc = bounded_latent_trunc), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         code_scan = code_txt_scanned, hmc_globally_ok = hmc_globally_ok), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         hmc = hmc_res))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;bytecode: 0x5585a909e2b8&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;environment: namespace:samOptiPro&gt;</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Romuald Hounyeme, Etienne Rivot.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

