% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/diagnostics.R
\name{configure_hmc_safely_bis}
\alias{configure_hmc_safely_bis}
\title{Configure and run HMC/NUTS safely (global / subset / auto)}
\usage{
configure_hmc_safely_bis(
  build_fn,
  niter,
  nburnin,
  thin,
  nchains,
  monitors = NULL,
  nuts_mode = c("all", "subset", "auto", "none"),
  nuts_nodes = NULL,
  enable_WAIC = FALSE,
  buildDerivs = TRUE,
  compiler_cores = max(1L, parallel::detectCores(TRUE)\%/\%2L),
  show_compiler_output = TRUE,
  project_name = NULL,
  out_dir = NULL,
  inits = NULL,
  save_samples = TRUE
)
}
\arguments{
\item{build_fn}{Function; model builder (e.g. \code{build_M}) used to
create the NIMBLE model before configuring HMC/NUTS.
If \code{.fresh_build()} exists, it will be called as
\code{.fresh_build(build_fn, monitors, thin)}.
Otherwise, \code{build_fn()} must return a list with at least
\code{model} and \code{conf} (NIMBLE objects).}

\item{niter}{Integer. Total number of iterations.}

\item{nburnin}{Integer (>= 0). Number of burn-in iterations (0 allowed).}

\item{thin}{Integer (>= 1). Thinning interval.}

\item{nchains}{Integer (>= 1). Number of chains.}

\item{monitors}{Character vector or \code{NULL}. Passed through to
building and/or global HMC configuration.}

\item{nuts_mode}{Character. One of \code{c("all","subset","auto","none")}:
\describe{
\item{"all"}{Global NUTS via \code{nimbleHMC::configureHMC(model, monitors = ..., enableWAIC = ..., buildDerivs = ...)}.}
\item{"subset"}{NUTS only on \code{nuts_nodes} via
\code{nimbleHMC::configureHMC(conf, model, nodes = ..., ...)}.}
\item{"auto"}{Let \code{nimbleHMC::configureHMC(conf, model, ...)} choose targets automatically.}
\item{"none"}{Do not modify the existing configuration.}
}}

\item{nuts_nodes}{Character vector of node names (can include indexed forms
such as \code{"beta[]"}) when \code{nuts_mode = "subset"}.}

\item{enable_WAIC}{Logical. Only relevant for \code{"all"} (model-signature path).}

\item{buildDerivs}{Logical. Passed to \code{nimbleHMC::configureHMC()}.}

\item{compiler_cores}{Integer. Passed to
\code{nimbleOptions(numCompilerCores = ...)}.}

\item{show_compiler_output}{Logical. Passed to
\code{nimbleOptions(showCompilerOutput = ...)}.}

\item{project_name}{Character or \code{NULL}. If non-\code{NULL}, sets
\code{options(nimbleProjectName = ...)} to sanitize the C++ cache.}

\item{out_dir}{Character or \code{NULL}. If non-\code{NULL}, saves a
\code{sessionInfo()} log and, optionally, samples as \code{.rds}.}

\item{inits}{\code{NULL} or a list of per-chain initial values to pass to
\code{nimble::runMCMC()} (length must match \code{nchains} if provided).}

\item{save_samples}{Logical. If \code{TRUE} (default) and \code{out_dir} is
non-\code{NULL}, save \code{samples} as \code{.rds}. If \code{FALSE},
skip saving samples.}
}
\value{
A list with elements:
\itemize{
\item \code{conf}: final MCMC configuration (with HMC/NUTS if configured),
\item \code{cmcmc}: compiled MCMC object,
\item \code{samples}: \code{coda::mcmc.list} of posterior samples,
\item \code{runtime_s}: wall time in seconds,
\item \code{build}: the build object returned by \code{build_fn} or
\code{.fresh_build()}.
}
}
\description{
Minimal, strict wrapper around NIMBLE + nimbleHMC that:
\enumerate{
\item builds the model,
\item configures NUTS either globally (model signature),
on a subset of nodes (conf + model + nodes signature),
or in auto mode,
\item compiles the MCMC,
\item runs MCMC.
}
}
\details{
No per-node fallback such as \code{addSampler("NUTS")} is attempted:
on error, the function stops.
}
