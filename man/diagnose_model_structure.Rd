% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/diagnostics.R
\name{diagnose_model_structure}
\alias{diagnose_model_structure}
\title{Diagnose model structure, dependencies, and per-sampler time (parameter- and family-level)}
\usage{
diagnose_model_structure(
  model,
  include_data = FALSE,
  removed_nodes = NULL,
  ignore_patterns = c("^lifted_", "^logProb_"),
  make_plots = TRUE,
  output_dir = NULL,
  save_csv = FALSE,
  node_of_interest = NULL,
  sampler_times = NULL,
  sampler_times_unit = "seconds",
  auto_profile = TRUE,
  profile_niter = 2000L,
  profile_burnin = 500L,
  profile_thin = 1L,
  profile_seed = NULL,
  np = 0.1,
  by_family = TRUE,
  family_stat = c("median", "mean", "sum"),
  time_normalize = c("none", "per_node"),
  only_family_plots = FALSE,
  ...
)
}
\arguments{
\item{model}{A compiled or uncompiled \code{nimbleModel} (required).}

\item{include_data}{Logical; include data nodes when enumerating nodes (default \code{FALSE}).}

\item{removed_nodes}{Character vector of nodes to exclude explicitly (default \code{NULL}).}

\item{ignore_patterns}{Character vector of regex patterns to exclude (e.g., \code{"^lifted_"}, \code{"^logProb_"}).}

\item{make_plots}{Logical; if \code{TRUE}, generate ggplot objects and optionally save them (default \code{TRUE}).}

\item{output_dir}{Directory where figures/CSVs will be saved; if \code{NULL}, nothing is written (default \code{NULL}).}

\item{save_csv}{Logical; if \code{TRUE}, write CSV exports (dependencies per node, family tables) (default \code{FALSE}).}

\item{node_of_interest}{Optional character vector of nodes to highlight or subset (reserved for user logic) (default \code{NULL}).}

\item{sampler_times}{Optional numeric vector of per-sampler times aligned with \code{configureMCMC(model)$getSamplers()}.}

\item{sampler_times_unit}{Character label for time axis (e.g., \code{"seconds"}, \code{"ms"}) (default \code{"seconds"}).}

\item{auto_profile}{Logical; if \code{TRUE} and \code{sampler_times} is \code{NULL}, profile sampler times automatically (default \code{TRUE}).}

\item{profile_niter}{Integer; iterations used by the auto-profiler (default \code{2000L}).}

\item{profile_burnin}{Integer; burn-in iterations for auto-profiler (default \code{500L}).}

\item{profile_thin}{Integer; thinning for auto-profiler (default \code{1L}).}

\item{profile_seed}{Optional integer seed for reproducibility (default \code{NULL}).}

\item{np}{Proportion in (0,1] used elsewhere for “worst sampler” selection (kept for API compatibility) (default \code{0.10}).}

\item{by_family}{Logical; if \code{TRUE}, compute and plot family-level summaries in addition to parameter-level (default \code{TRUE}).}

\item{family_stat}{One of \code{c("median","mean","sum")}; summary statistic for family-level aggregation (default \code{"median"}).}

\item{time_normalize}{One of \code{c("none","per_node")}; if \code{"per_node"}, divide family time by the number of distinct nodes in the family (default \code{"none"}).}

\item{only_family_plots}{Logical; if \code{TRUE}, only family-level figures are exported (parameter plots not written).}

\item{...}{Additional arguments forwarded to \code{nimble::configureMCMC()}.}
}
\value{
A named list containing:
\itemize{
\item \code{dependencies_df}        : data.frame of (node, dependency) pairs,
\item \code{dep_counts}             : data.frame with per-parameter downstream dependency counts,
\item \code{samplers_df}            : data.frame listing samplers and their target nodes (list-column),
\item \code{per_param_times}        : data.frame with per-parameter aggregated sampler time,
\item \code{deps_df}                : tidy data.frame used for parameter-level dependency plotting,
\item \code{sampler_df}             : tidy data.frame used for parameter-level time plotting,
\item \code{fam_deps_df}            : family-level dependency summary (statistic per family),
\item \code{fam_time_df}            : family-level time summary (optionally normalized),
\item \code{plots}                  : list of ggplot objects (some may be \code{NULL} if not created):
\code{plot_dependencies}, \code{plot_sampler_time}, \code{plot_combined},
\code{plot_dependencies_family}, \code{plot_sampler_time_family}, \code{plot_combined_family}.
}
}
\description{
Inspect a NIMBLE model to extract the universe of nodes, classify stochastic vs.
deterministic nodes, compute downstream dependencies per node, map configured samplers
to their target nodes, and (optionally) profile per-sampler run time. Produces tidy
tables and publication-quality figures at both the \emph{parameter} level and the
\emph{family} level (where "family" = base variable name before any "i,j" index,
replacing indices by \code{[]}).

Key features:
\itemize{
\item Robust filtering of nodes (ignored patterns, removal list).
\item Downstream dependency counts per node (+ per family via summary stats).
\item Per-sampler times aggregated to parameters (+ per family with optional normalization).
\item Optional auto-profiling of samplers via a short MCMC run.
\item Non-regressive: original per-parameter plots are preserved by default.
}
}
\examples{
\dontrun{
res <- diagnose_model_structure(
  model = my_nimble_model,
  make_plots = TRUE,
  output_dir = "outputs/diagnostics",
  save_csv = TRUE,
  by_family = TRUE,
  family_stat = "median",
  time_normalize = "per_node",
  only_family_plots = FALSE
)
}

}
