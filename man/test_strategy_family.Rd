% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/diagnostics.R
\name{test_strategy_family}
\alias{test_strategy_family}
\title{Family-based sampler strategy: full HMC if allowed, else surgical on bottlenecks}
\usage{
test_strategy_family(
  build_fn,
  monitors = NULL,
  try_hmc = TRUE,
  nchains = 3L,
  pilot_niter = 4000L,
  pilot_burnin = 1000L,
  thin = 2L,
  out_dir = "outputs/diagnostics_family",
  nbot = 1L,
  strict_scalar_seq = c("NUTS", "slice", "RW"),
  strict_block_seq = c("NUTS_block", "AF_slice", "RW_block"),
  force_families = NULL,
  force_nodes = NULL,
  force_union = NULL,
  ask = TRUE,
  ask_before_hmc = TRUE,
  block_max = 20L,
  slice_control = list(),
  rw_control = list(),
  rwblock_control = list(adaptScaleOnly = TRUE),
  af_slice_control = list(),
  slice_max_contractions = 5000L
)
}
\arguments{
\item{build_fn}{Function; returns \code{list(model, cmodel?, monitors?)} used by the runners.}

\item{monitors}{Character or \code{NULL}; root names to monitor (\code{NULL} = auto).}

\item{try_hmc}{Logical; if \code{TRUE} and structure allows, run full HMC path.}

\item{nchains}{Integer; number of chains.}

\item{pilot_niter}{Integer; iterations for pilot runs.}

\item{pilot_burnin}{Integer; burn-in for pilot runs.}

\item{thin}{Integer; thinning factor.}

\item{out_dir}{Character; output directory for diagnostics/plots.}

\item{nbot}{Integer (\eqn{\ge} 1); number of bottleneck nodes to act on simultaneously.}

\item{strict_scalar_seq}{Character; sampler order for scalar mode.}

\item{strict_block_seq}{Character; sampler order for block mode (\code{nbot >= 2}).}

\item{force_families}{Character or \code{NULL}; families to force.}

\item{force_nodes}{List or \code{NULL}; per-family forced node vectors.}

\item{force_union}{Character or \code{NULL}; families to union for block stage.}

\item{ask}{Logical; interactive confirmation after each step.}

\item{ask_before_hmc}{Logical; ask before attempting full-model HMC.}

\item{block_max}{Integer; maximum block size.}

\item{slice_control, rw_control, rwblock_control, af_slice_control}{Lists; sampler controls.}

\item{slice_max_contractions}{Integer; informational safety for AF_slice.}
}
\value{
A list describing baseline, steps, configurations, diagnostics, and plot paths.
}
\description{
If the model is differentiable and \code{try_hmc = TRUE}, this runs a full
HMC/NUTS configuration (via \code{configure_hmc_safely()}), executes the baseline,
prints/plots diagnostics, and returns. Otherwise it switches to a
\strong{surgical strategy}: it ranks families by median efficiency, extracts
stochastic bottleneck nodes, and iteratively applies samplers on 1 or more nodes
(\code{nbot}) in the order:
\itemize{
\item scalar: \code{NUTS} -> \code{slice} -> \code{RW}
\item block (when \code{nbot >= 2}): \code{NUTS_block} -> \code{AF_slice} -> \code{RW_block}
}
After each assignment, a short MCMC is run, a side-by-side comparison versus the
baseline is printed (runtime, AE = ESS/iter, CE = ESS/s, Rhat), clean plots are saved
(Rhat bars + trace plots for the touched nodes), and the user is prompted to continue
unless \code{ask = FALSE}.
}
