% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/diagnostics.R
\name{test_strategy}
\alias{test_strategy}
\title{Test and compare MCMC strategies on selected bottleneck nodes}
\usage{
test_strategy(
  build_fn,
  monitors = NULL,
  try_hmc = TRUE,
  nchains = 3L,
  pilot_niter = 20000,
  pilot_burnin = 5000,
  thin = 1L,
  out_dir = "outputs/diagnostics",
  nbot = 1L,
  strict_scalar_seq = c("NUTS", "slice", "RW"),
  strict_block_seq = c("NUTS_block", "AF_slice", "RW_block"),
  force_singletons = NULL,
  force_union_nodes = NULL,
  force_union = NULL,
  ask = TRUE,
  ask_before_hmc = TRUE,
  block_max = 20L,
  slice_control = list(),
  rw_control = list(),
  rwblock_control = list(adaptScaleOnly = TRUE),
  af_slice_control = list(),
  slice_max_contractions = 5000L
)
}
\arguments{
\item{build_fn}{Function (or prebuilt list with \code{$model}, \code{$conf})
that returns a fresh build object used by samplers in this package.}

\item{monitors}{Optional character vector of monitors passed to the build.}

\item{try_hmc}{Logical. If \code{TRUE}, try a full-model HMC/NUTS run first
(ignored by the “surgical” singleton/block steps).}

\item{nchains}{Integer number of MCMC chains for each run.}

\item{pilot_niter}{Integer total iterations used in baseline and tests.}

\item{pilot_burnin}{Integer burn-in iterations.}

\item{thin}{Integer thinning interval.}

\item{out_dir}{Directory where outputs (plots, etc.) will be written.}

\item{nbot}{Integer. Number of bottleneck targets to operate on (1 or 2
typical; if \code{>= 2}, a block step on the union is attempted).}

\item{strict_scalar_seq}{Character vector of scalar samplers to try in order.
Supported values include \code{"NUTS"}, \code{"slice"}, \code{"RW"}.}

\item{strict_block_seq}{Character vector of block samplers to try in order.
Supported values include \code{"NUTS_block"}, \code{"AF_slice"},
\code{"RW_block"}.}

\item{force_singletons}{Optional character vector of node names to force as
singleton targets (first \code{nbot} valid nodes are used).}

\item{force_union_nodes}{Optional character vector of node names to define
the union for the block phase (must contain \code{>= 2} valid nodes).}

\item{force_union}{Deprecated alias of \code{force_union_nodes}.}

\item{ask}{Logical. If \code{TRUE}, ask before moving to the next step.}

\item{ask_before_hmc}{Logical. If \code{TRUE}, ask before running full HMC.}

\item{block_max}{Integer cap on the size of the block union.}

\item{slice_control}{List of controls passed to \code{"slice"} samplers.}

\item{rw_control}{List of controls passed to \code{"RW"} samplers.}

\item{rwblock_control}{List of controls passed to \code{"RW_block"} samplers.}

\item{af_slice_control}{List of controls passed to \code{"AF_slice"} samplers.}

\item{slice_max_contractions}{Integer safety cap for slice contractions.}
}
\value{
A list with elements such as:
\describe{
\item{status}{Character status string.}
\item{mode}{Character mode (e.g. \code{"HMC_full"}, \code{"surgical_*"}).}
\item{baseline}{Baseline run info (runtime, samples, diagnostics).}
\item{targets}{Chosen target node names.}
\item{steps}{List of steps; each contains nodes, sampler, results, and directory.}
}
}
\description{
Runs a small, reproducible workflow to (i) build a model via \code{build_fn},
(ii) compute a baseline with the default MCMC configuration, then (iii)
try alternative samplers in a \emph{strict}, user-defined order on one or two
“bottleneck” targets (singleton and then optional block on the union).
Optionally attempts full-model HMC/NUTS first (if \code{nimbleHMC} is available
and the model supports derivatives). Results and diagnostic plots
(R-hat bars and trace/density) are written under \code{out_dir}.
}
\details{
The procedure:
\enumerate{
\item Build and run a baseline MCMC using \code{run_baseline_config()}.
\item Optionally run full-model HMC/NUTS via \code{configure_hmc_safely()}.
\item Select \code{nbot} bottleneck node(s) from diagnostics (or from
\code{force_singletons}), then:
\itemize{
\item apply \code{strict_scalar_seq} in order on the first node;
\item if \code{nbot >= 2}, build the union \code{\{node1, node2\}}
(or \code{force_union_nodes}) and apply \code{strict_block_seq}.
}
\item For each step, compile, run, compute diagnostics, and save plots.
}
When \code{ask = TRUE}, interactive yes/no prompts allow you to stop early.
}
\section{Side effects}{

Creates subfolders and PNG files (R-hat bars, traces/densities) under
\code{out_dir}. May load/unload compiled DLLs while switching samplers.
}

\examples{
\dontrun{
res <- test_strategy(
  build_fn = my_build_fn,
  monitors = c("theta","beta"),
  try_hmc  = TRUE,
  nbot     = 2,
  out_dir  = "outputs/diagnostics"
)
}

}
\seealso{
\code{\link{configure_hmc_safely}},
\code{\link{plot_convergence_checks}}, \code{\link{plot_bottlenecks}}
}
